#!/bin/bash

USER_ACCOUNT=${USER:-"unknown_user"}
REPOS=(~/mysoft/pei/vasp_utils ~/mysoft/pei/mymetal)

for REPO in "${REPOS[@]}"; do
    if [ -d "$REPO" ]; then
        echo "üì¶ ==> Updating repository in $REPO"
        cd "$REPO" || continue

        # Ê£ÄÊü•ÊòØÂê¶ÊúâÊîπÂä®ÔºàÂåÖÊã¨Âà†Èô§Ôºâ
        if [[ -n $(git status --porcelain) ]]; then
            echo "‚ö†Ô∏è  Detected unstaged changes."

            # Ê∑ªÂä†ÊâÄÊúâÊõ¥ÊîπÔºàÂåÖÂê´Âà†Èô§Ôºâ
            git add -A
            git commit -m "Update from $USER_ACCOUNT."

        else
            echo "‚úÖ No changes to commit in $REPO."
        fi

        # Â§ÑÁêÜÂèØËÉΩÂõ† unstaged changes ÈòªÊ≠¢ÁöÑ pull --rebase
        if [[ -n $(git status --porcelain) ]]; then
            echo "üì• Stashing local changes before rebase pull..."
            git stash push -m "auto-stash before pull"
            git pull --rebase
            git stash pop || echo "‚ö†Ô∏è  Conflict during stash pop. Please resolve manually."
        else
            git pull --rebase
        fi

        # Êé®ÈÄÅÊõ¥Êîπ
        git push

        cd - > /dev/null
    else
        echo "‚ùå Repository $REPO does not exist."
    fi

    echo "‚úÖ Done syncing: $REPO"
    printf '=%.0s' {1..80}; echo
done
