#!/bin/bash

USER_ACCOUNT=${USER:-"unknown_user"}
REPOS=(~/mysoft/pei/vasp_utils ~/mysoft/pei/mymetal)

for REPO in "${REPOS[@]}"; do
    if [ -d "$REPO" ]; then
        echo "ðŸ“¦ ==> Updating repository in $REPO"
        cd "$REPO" || continue

        # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨ï¼ˆåŒ…æ‹¬åˆ é™¤ï¼‰
        if [[ -n $(git status --porcelain) ]]; then
            echo "âš ï¸  Detected unstaged changes."

            # æ·»åŠ æ‰€æœ‰æ›´æ”¹ï¼ˆåŒ…å«åˆ é™¤ï¼‰
            git add -A
            git commit -m "Update from $USER_ACCOUNT."

        else
            echo "âœ… No changes to commit in $REPO."
        fi

        # å¤„ç†å¯èƒ½å›  unstaged changes é˜»æ­¢çš„ pull --rebase
        if [[ -n $(git status --porcelain) ]]; then
            echo "ðŸ“¥ Stashing local changes before rebase pull..."
            git stash push -m "auto-stash before pull"
            git pull --rebase
            git stash pop || echo "âš ï¸  Conflict during stash pop. Please resolve manually."
        else
            git pull --rebase
        fi

        # æŽ¨é€æ›´æ”¹
        git push

        cd - > /dev/null
    else
        echo "âŒ Repository $REPO does not exist."
    fi

    echo "âœ… Done syncing: $REPO"
    printf '=%.0s' {1..80}; echo
done



# #!/bin/bash

# USER_ACCOUNT=${USER:-"unknown_user"}
# REPOS=(~/mysoft/pei/vasp_utils ~/mysoft/pei/mymetal)

# for REPO in "${REPOS[@]}"; do
#     if [ -d "$REPO" ]; then
#         echo "==> Updating repository in $REPO"
#         cd "$REPO"

#         # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹å¹¶æäº¤
#         if [[ -n $(git status --porcelain) ]]; then
#             git add .
#             git commit -m "Update from $USER_ACCOUNT."
#         else
#             echo "No changes to commit in $REPO."
#         fi

#         # æ‹‰å–å’ŒæŽ¨é€åˆ°å·²è®¾ç½®çš„ä¸Šæ¸¸åˆ†æ”¯
#         git pull --rebase  # ä½¿ç”¨ --rebase ä»¥å‡å°‘åˆå¹¶å†²çª
#         git push

#         cd - > /dev/null
#     else
#         echo "Repository $REPO does not exist."
#     fi
#     echo "done!"
#     printf '=%.0s' {1..80}; echo
# done

