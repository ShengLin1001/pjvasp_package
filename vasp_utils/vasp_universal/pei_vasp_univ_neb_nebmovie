#!/bin/bash

main(){
    mode=${1:-0}  # é»˜è®¤å‚æ•°ä¸º0
    nebmovie "$mode"
}

nebmovie(){
    mode=$1
    if [[ "$mode" == "1" ]]; then
        target_file="CONTCAR"
    else
        target_file="POSCAR"
    fi
    output_file="movie_${target_file}.xyz"

    echo "==========================================================="
    echo "ğŸ“‹ INFO:"
    echo "ğŸ“ Collecting structure files from numeric subdirectories"
    echo "ğŸ“„ Target file type: $target_file"
    echo "ğŸ“¤ Output will be saved as: $output_file"
    echo "ğŸ”§ Used tool: ASE (Atomic Simulation Environment)"
    echo "ğŸ’¡ Example usage:"
    echo "    >>> bash nebmovie.sh         # Uses POSCAR (default)"
    echo "    >>> bash nebmovie.sh 1       # Uses CONTCAR"
    echo "==========================================================="

    rm -f "$output_file"
    echo "ğŸ“¦ Starting to collect and write structures..."

    python3 -c "
from ase.io import write
from ase.io.vasp import read_vasp
import os

folders = [folder for folder in os.listdir() if os.path.isdir(folder) and folder.isdigit()]
print(f'ğŸ“ Found directory: {folders}')

output_file = '$output_file'
target_file = '$target_file'
atoms_list = []

for folder in sorted(folders, key=lambda x: int(x)):
    print(f'ğŸ“¥ Appending: {folder}')
    file_path = os.path.join(folder, target_file)
    if os.path.exists(file_path):
        atoms = read_vasp(file_path)
        atoms_list.append(atoms)

write(output_file, atoms_list, format='extxyz')
print(f'âœ… Successfully generated: {output_file}')
    "

    echo "==========================================================="
    echo "ğŸ‰ DONE:"
    echo "ğŸ“Š Total structures processed: ${#folders[@]}"
    echo "ğŸ“„ Output file: $output_file"
    echo "âœ… All structure data extracted and combined successfully."
    echo "==========================================================="
}

main "$@"; exit
