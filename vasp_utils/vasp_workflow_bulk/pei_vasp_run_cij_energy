#!/bin/bash
# B. Yin, 2021-09-16
# Revised by J. Pei, 2025-11-04
# pei_vasp_run_Cij_energy.sh
#  >>> Default strain list: -0.003 -0.002 -0.001 0.000 0.001 0.002 0.003
#  >>> Example usage:
#      ./pei_vasp_run_Cij_energy.sh
#      ./pei_vasp_run_Cij_energy.sh -e -0.005 -0.002 0.000 0.002 0.005

main(){
    # ---------- Colors ----------
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'

    srcdir0=y_full_relax

    # ---------- Help ----------
    if [[ "$1" == "--help" || "$1" == "-h" ]]; then
        echo -e "${GREEN}pei_vasp_run_Cij_energy${NC} - Calculate Cij energy variations"
        echo ""
        echo -e "${YELLOW}Usage:${NC}"
        echo -e "  $0 [-e <list_of_strain_values>]"
        echo ""
        echo -e "${YELLOW}Default strain list:${NC} -0.003 -0.002 -0.001 0.000 0.001 0.002 0.003"
        echo ""
        echo -e "${YELLOW}Example:${NC}"
        echo -e "  $0"
        echo -e "  $0 -e -0.005 -0.002 0.000 0.002 0.005"
        echo -e "  $0 -no-submit"
        exit 0
    fi

    script_name=$(basename "$0")
    logfile="${script_name}.log"

    # üìú Log everything to file and terminal
    exec > >(tee "$logfile") 2>&1

    echo -e "üü¢ ===== ${GREEN}Run started${NC} at: $(date) ====="
    echo -e "üìå Command: ${BLUE}$0${NC} $@"
    echo "==============================="

    # ---------- Check source directory ----------
    if [ -d "$srcdir0" ]; then
        sub_run_Cij_energy "$@"
    else
        echo -e "‚ùå ${YELLOW}ERROR${NC}: No ${BLUE}$srcdir0${NC} found! Abort!"
        exit
    fi
}





sub_run_Cij_energy(){
    myroot=$(pwd)
    srcdir=$myroot/y_full_relax_temp

    echo -e "üßπ Preparing working directory..."
    rm -rf $srcdir
    cp -r $srcdir0  $srcdir 
    cd $srcdir

    echo -e "${GREEN}pei_vasp_run_Cij_energy${NC} - Calculate Cij energy variations"
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo -e "  $0 [-e <list_of_strain_values>]"
    echo ""
    echo -e "${YELLOW}Default strain list:${NC} -0.003 -0.002 -0.001 0.000 0.001 0.002 0.003"
    echo ""
    echo -e "${YELLOW}Example:${NC}"
    echo -e "  $0"
    echo -e "  $0 -e -0.005 -0.002 0.000 0.002 0.005"
    echo -e "  $0 -no-submit"

    # ---------- Check CONTCAR ----------
    if [ -f "CONTCAR" ]; then
        echo -e "‚úÖ ${GREEN}CONTCAR exists.${NC}"
    else
        echo -e "‚ö†Ô∏è  ${YELLOW}CONTCAR not found. Copy POSCAR ‚Üí CONTCAR${NC}"
        cp POSCAR CONTCAR
    fi

    # ---------- VASP setup ----------
    #yin_vasp_univ_find_and_change  -isym  0 
    yin_vasp_univ_find_and_change  -isif  2
    pei_vasp_univ_find_and_change  -lcharg F

    #yin_slurm_find_and_change  -srpl  H

    echo -e "0\n0.0  0.0  0.0  0.0  0.0  0.0" > Y_CONSTR_LATT #Y_CONSTR_CELL.IN

    # ---------- Parse -e option ----------
    # read -e list
    le_default=(-0.003 -0.002 -0.001 0.000 0.001 0.002 0.003)
    le=("${le_default[@]}")
    submit_task=true  # ÈªòËÆ§Êèê‰∫§‰ªªÂä°

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -e)
                shift
                le=()
                # Âè™ÊääÁúüÊ≠£ÁöÑÈÄâÈ°πË∑≥ËøáÔºåË¥üÊï∞‰∏çË∑≥Ëøá
                while [[ $# -gt 0 && ! "$1" =~ ^-[^0-9] ]]; do
                    le+=("$1")
                    shift
                done
                ;;
            -no-submit)
                submit_task=false
                shift
                ;;
            *)
                echo -e "‚ùå ${YELLOW}Unknown option${NC}: $1"
                exit 1
                ;;
        esac
    done


    echo -e "üìè Strain list: ${BLUE}${le[*]}${NC}"
    
    cd ..

    
    #--------------------   
 
    a1=`sed -n '3,3p' $srcdir/CONTCAR | awk '{printf "%.16f", $1}'`
    a2=`sed -n '3,3p' $srcdir/CONTCAR | awk '{printf "%.16f", $2}'`
    a3=`sed -n '3,3p' $srcdir/CONTCAR | awk '{printf "%.16f", $3}'`
    
    b1=`sed -n '4,4p' $srcdir/CONTCAR | awk '{printf "%.16f", $1}'`
    b2=`sed -n '4,4p' $srcdir/CONTCAR | awk '{printf "%.16f", $2}'`
    b3=`sed -n '4,4p' $srcdir/CONTCAR | awk '{printf "%.16f", $3}'`
    
    c1=`sed -n '5,5p' $srcdir/CONTCAR | awk '{printf "%.16f", $1}'`
    c2=`sed -n '5,5p' $srcdir/CONTCAR | awk '{printf "%.16f", $2}'`
    c3=`sed -n '5,5p' $srcdir/CONTCAR | awk '{printf "%.16f", $3}'`
    
    echo $a1 $a2 $a3
    echo $b1 $b2 $b3
    echo $c1 $c2 $c3
    
    
    # ---------- Create output directory ----------
    dirCij=y_cij_energy
    echo -e "üßπ Creating output directory: ${BLUE}$dirCij${NC}"

    rm -rI  $dirCij
    mkdir   $dirCij
    cd      $dirCij

    #=====================
        
    dirlist="
    y_cij_energy_c11
    y_cij_energy_c12
    y_cij_energy_c13
    y_cij_energy_c33
    y_cij_energy_c44
    "


    # ---------- Loop over Cij directions ----------

    for i1 in $dirlist;  do
    
        dirn=$i1
        echo -e "\n================ ${BLUE}$dirn${NC} ================"
        
        mkdir   $dirn
        cd      $dirn
        cp $srcdir/sub*sequential.sh ./

        mkdir y_dir
        cd    y_dir
    

        #=====================
        for e in "${le[@]}"; do
            el=`echo "scale=16; $e+1" | bc`
            dirn2=`printf "%.4f" "$el"`
            echo -e "‚û°Ô∏è  Processing strain: ${BLUE}$e${NC} ‚Üí dir: $dirn2"

            mkdir $dirn2
            cd $dirn2
    
            echo -e "üßπ Copying working directory from ${BLUE}$srcdir${NC}"
            cp $srcdir/{INCAR,KPOINTS,CONTCAR,POTCAR,Y_*,CHGCAR} ./
            mv CONTCAR POSCAR
        

        
            if [ "$dirn" == "y_cij_energy_c11" ]; then
                a11=`echo "scale=16; $a1+ $a1*$e" | bc`
                b11=`echo "scale=16; $b1+ $b1*$e" | bc`
                c11=`echo "scale=16; $c1+ $c1*$e" | bc`
    
                latta=`printf "%.16f  %.16f  %.16f"   "$a11" "$a2" "$a3"`
                lattb=`printf "%.16f  %.16f  %.16f"   "$b11" "$b2" "$b3"`
                lattc=`printf "%.16f  %.16f  %.16f"   "$c11" "$c2" "$c3"`
    


            elif [ "$dirn" == "y_cij_energy_c12" ]; then
                a11=`echo "scale=16; $a1+ $a1*$e" | bc`
                b11=`echo "scale=16; $b1+ $b1*$e" | bc`
                c11=`echo "scale=16; $c1+ $c1*$e" | bc`
            
                a22=`echo "scale=16; $a2+ $a2*$e" | bc`
                b22=`echo "scale=16; $b2+ $b2*$e" | bc`
                c22=`echo "scale=16; $c2+ $c2*$e" | bc`
            
                latta=`printf "%.16f  %.16f  %.16f"   "$a11" "$a22" "$a3"`
                lattb=`printf "%.16f  %.16f  %.16f"   "$b11" "$b22" "$b3"`
                lattc=`printf "%.16f  %.16f  %.16f"   "$c11" "$c22" "$c3"`
            


            elif [ "$dirn" == "y_cij_energy_c13" ]; then
                a11=`echo "scale=16; $a1+ $a1*$e" | bc`
                b11=`echo "scale=16; $b1+ $b1*$e" | bc`
                c11=`echo "scale=16; $c1+ $c1*$e" | bc`
                
                a33=`echo "scale=16; $a3+ $a3*$e" | bc`
                b33=`echo "scale=16; $b3+ $b3*$e" | bc`
                c33=`echo "scale=16; $c3+ $c3*$e" | bc`
                
                latta=`printf "%.16f  %.16f  %.16f"   "$a11" "$a2" "$a33"`
                lattb=`printf "%.16f  %.16f  %.16f"   "$b11" "$b2" "$b33"`
                lattc=`printf "%.16f  %.16f  %.16f"   "$c11" "$c2" "$c33"`



            elif [ "$dirn" == "y_cij_energy_c33" ]; then
                a33=`echo "scale=16; $a3+ $a3*$e" | bc`
                b33=`echo "scale=16; $b3+ $b3*$e" | bc`
                c33=`echo "scale=16; $c3+ $c3*$e" | bc`
                
                latta=`printf "%.16f  %.16f  %.16f"   "$a1" "$a2" "$a33"`
                lattb=`printf "%.16f  %.16f  %.16f"   "$b1" "$b2" "$b33"`
                lattc=`printf "%.16f  %.16f  %.16f"   "$c1" "$c2" "$c33"`


            # shear yz, a_2 = (a2, b2, c2) and a_3 = (a3, b3, c3)
            # ‰ºöÂºïÂÖ• xz shear, ÊâÄ‰ª•ÂÖ∂ÂÆûÂºïÂÖ•ÁöÑÊòØshear 23, ËÄåÈùû shear yz
            # Âè™ÊúâÂú®cubic cellÊó∂Ôºå‰∏ãÂºèÁÆóÂá∫ÁöÑC44ÊâçÊòØÂØπÂ∫îshear yzÁöÑ
            elif [ "$dirn" == "y_cij_energy_c44" ]; then
                a33=`echo "scale=16; $a3+ $a2*$e" | bc`
                b33=`echo "scale=16; $b3+ $b2*$e" | bc`
                c33=`echo "scale=16; $c3+ $c2*$e" | bc`
                
                latta=`printf "%.16f  %.16f  %.16f"   "$a1" "$a2" "$a33"`
                lattb=`printf "%.16f  %.16f  %.16f"   "$b1" "$b2" "$b33"`
                lattc=`printf "%.16f  %.16f  %.16f"   "$c1" "$c2" "$c33"`

            fi 


            echo -e " "$latta "\n" $lattb "\n" $lattc
    
            sed '3s/.*/'"$latta"'/' ./POSCAR > ./temp1
            sed '4s/.*/'"$lattb"'/' ./temp1 > ./temp2
            sed '5s/.*/'"$lattc"'/' ./temp2 > ./POSCAR
            rm ./temp*


            cd ..
        done

        cd ..
        echo -e "üì§ Submit directory: $(pwd)"
        echo 'submit dir:' `pwd`
        if [ "$submit_task" = true ]; then
            sbatch sub.*
            echo -e "‚úÖ ${GREEN}Job submitted.${NC}"
        else
            echo -e "‚ö†Ô∏è ${YELLOW}Job submission skipped (dry run).${NC}"
        fi

        cd ..
    done

    echo -e "üßπ Cleaning temporary directory: $srcdir"
    rm -rf $srcdir
}



main "$@"; exit



